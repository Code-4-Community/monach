import x from 'express';
import { z } from 'zod';

function d(o,e){var t,r,i,n;return ((t=o._def)==null?void 0:t.typeName)===e?!0:((r=o._def)==null?void 0:r.typeName)===z.ZodFirstPartyTypeKind.ZodEffects&&o._def.effect.type==="refinement"?d(o.innerType(),e):(i=o._def)!=null&&i.innerType?d((n=o._def)==null?void 0:n.innerType,e):!1}function p(o){var e;return ((e=o._def)==null?void 0:e.typeName)===z.ZodFirstPartyTypeKind.ZodEffects?p(o.innerType()):o}var O=["get","post","put","patch","delete"];async function m(o,e){return (d(o,z.ZodFirstPartyTypeKind.ZodNumber)||d(o,z.ZodFirstPartyTypeKind.ZodBoolean))&&e&&typeof e=="string"?z.preprocess(t=>{try{return JSON.parse(t)}catch{return t}},o).safeParseAsync(e):o.safeParseAsync(e)}function P(o,e){return async(t,r,i)=>{for(let n of o.parameters){let a=n.schema;switch(e||(a=p(a)),n.type){case"Body":{let s=await a.safeParseAsync(t.body);if(!s.success)return r.status(400).json({context:"body",error:s.error.issues});t.body=s.data;}break;case"Path":{let s=await m(a,t.params[n.name]);if(!s.success)return r.status(400).json({context:`path.${n.name}`,error:s.error.issues});t.params[n.name]=s.data;}break;case"Query":{let s=await m(a,t.query[n.name]);if(!s.success)return r.status(400).json({context:`query.${n.name}`,error:s.error.issues});t.query[n.name]=s.data;}break;case"Header":{let s=await n.schema.safeParseAsync(t.get(n.name));if(!s.success)return r.status(400).json({context:`header.${n.name}`,error:s.error.issues});t.headers[n.name]=s.data;}break}}i();}}function u(o,e,t){for(let r of O){let i=e[r].bind(e);e[r]=(n,...a)=>{let s=o.find(Z=>Z.method===r&&Z.path===n);return s&&s.parameters&&(a=[P(s,t),...a]),i(n,...a)};}}function c(o,e={}){let{express:t=x(),enableJsonBodyParser:r=!0,validate:i=!0,transform:n=!1}=e;return r&&t.use(x.json()),o&&i&&u(o,t,n),t}function l(o,e={}){let{validate:t=!0,transform:r=!1,...i}=e,n=(e==null?void 0:e.router)??x.Router(i);return t&&u(o,n,r),n}function C(o,e={}){return c(o,{...e,enableJsonBodyParser:!1})}var y=class{constructor(e){this.context=e;}app(e,t={}){return c(e,t)}nextApp(e,t={}){return C(e,t)}router(e,t){return l(e,t)}};function b(o){return new y(o)}

export { c as zodiosApp, b as zodiosContext, C as zodiosNextApp, l as zodiosRouter };
