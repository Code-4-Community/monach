import V, { AxiosError } from 'axios';
import S from 'zod';

function w(t,o){let e={...t};for(let i of o)delete e[i];return e}function B(t){return t.charAt(0).toUpperCase()+t.slice(1)}var N=/:([a-zA-Z_][a-zA-Z0-9_]*)/g;function q(t){let o=t.url,e=t.params;return e&&(o=o.replace(N,(i,n)=>n in e?`${e[n]}`:i)),o}function m(t,o,e){return t.find(i=>i.method===o&&i.path===e)}function j(t,o){return t.find(e=>e.alias===o)}function T(t,o){var i,n;let e=(i=t.errors)==null?void 0:i.filter(s=>s.status===o.response.status);return e&&e.length>0?e:(n=t.errors)==null?void 0:n.filter(s=>s.status==="default")}function O(t,o,e,i){let n=m(t,o,e);return n&&i.config&&n.method===i.config.method&&n.path===i.config.url?T(n,i):void 0}function k(t,o,e){let i=j(t,o);return i&&e.config&&i.method===e.config.method&&i.path===e.config.url?T(i,e):void 0}function $(t){let o=new FormData;for(let e in t)o.append(e,t[e]);return {data:o}}var u=class extends Error{constructor(e,i,n,s){super(e);this.config=i;this.data=n;this.cause=s;}};var U={name:"form-data",request:async(t,o)=>{if(typeof o.data!="object"||Array.isArray(o.data))throw new u("Zodios: multipart/form-data body must be an object",o);let e=$(o.data);return {...o,data:e.data,headers:{...o.headers,...e.headers}}}};function x(){return U}var F={name:"form-url",request:async(t,o)=>{if(typeof o.data!="object"||Array.isArray(o.data))throw new u("Zodios: application/x-www-form-urlencoded body must be an object",o);return {...o,data:new URLSearchParams(o.data).toString(),headers:{...o.headers,"Content-Type":"application/x-www-form-urlencoded"}}}};function E(){return F}function P(t,o){return {request:async(e,i)=>({...i,headers:{...i.headers,[t]:o}})}}function b(t){return [!0,"response","all"].includes(t)}function C(t){return [!0,"request","all"].includes(t)}function R({validate:t,transform:o,sendDefaults:e}){return {name:"zod-validation",request:C(t)?async(i,n)=>{let s=m(i,n.method,n.url);if(!s)throw new Error(`No endpoint found for ${n.method} ${n.url}`);let{parameters:r}=s;if(!r)return n;let d={...n,queries:{...n.queries},headers:{...n.headers},params:{...n.params}},c={Query:p=>{var a;return (a=d.queries)==null?void 0:a[p]},Body:p=>d.data,Header:p=>{var a;return (a=d.headers)==null?void 0:a[p]},Path:p=>{var a;return (a=d.params)==null?void 0:a[p]}},h={Query:(p,a)=>d.queries[p]=a,Body:(p,a)=>d.data=a,Header:(p,a)=>d.headers[p]=a,Path:(p,a)=>d.params[p]=a},I=C(o);for(let p of r){let{name:a,schema:z,type:Z}=p,g=c[Z](a);if(e||g!==void 0){let A=await z.safeParseAsync(g);if(!A.success)throw new u(`Zodios: Invalid ${Z} parameter '${a}'`,n,g,A.error);I&&h[Z](a,A.data);}}return d}:void 0,response:b(t)?async(i,n,s)=>{var d,c;let r=m(i,n.method,n.url);if(!r)throw new Error(`No endpoint found for ${n.method} ${n.url}`);if((c=(d=s.headers)==null?void 0:d["content-type"])!=null&&c.includes("application/json")){let h=await r.response.safeParseAsync(s.data);if(!h.success)throw new u(`Zodios: Invalid response from endpoint '${r.method} ${r.path}'
status: ${s.status} ${s.statusText}
cause:
${h.error.message}
received:
${JSON.stringify(s.data,null,2)}`,n,s.data,h.error);b(o)&&(s.data=h.data);}return s}:void 0}}var l=class{constructor(o,e){this.plugins=[];this.key=`${o}-${e}`;}indexOf(o){return this.plugins.findIndex(e=>(e==null?void 0:e.name)===o)}use(o){if(o.name){let e=this.indexOf(o.name);if(e!==-1)return this.plugins[e]=o,{key:this.key,value:e}}return this.plugins.push(o),{key:this.key,value:this.plugins.length-1}}eject(o){if(typeof o=="string"){let e=this.indexOf(o);if(e===-1)throw new Error(`Plugin with name '${o}' not found`);this.plugins[e]=void 0;}else {if(o.key!==this.key)throw new Error(`Plugin with key '${o.key}' is not registered for endpoint '${this.key}'`);this.plugins[o.value]=void 0;}}async interceptRequest(o,e){let i=e;for(let n of this.plugins)n!=null&&n.request&&(i=await n.request(o,i));return i}async interceptResponse(o,e,i){let n=i;for(let s=this.plugins.length-1;s>=0;s--){let r=this.plugins[s];r&&(n=n.then(r!=null&&r.response?d=>r.response(o,e,d):void 0,r!=null&&r.error?d=>r.error(o,e,d):void 0));}return n}count(){return this.plugins.reduce((o,e)=>e?o+1:o,0)}};function y(t){let o=new Set;for(let e of t){let i=`${e.method} ${e.path}`;if(o.has(i))throw new Error(`Zodios: Duplicate path '${i}'`);o.add(i);}}function M(t){return y(t),t}function K(t){return t}function L(t){return t}function _(t){return t}var f=class{constructor(o){this.api=o;}addEndpoint(o){return new f([...this.api,o])}build(){return y(this.api),this.api}};function H(t){return new f([t])}function Q(t,o){let e=B(t);return M([{method:"get",path:`/${t}s`,alias:`get${e}s`,description:`Get all ${t}s`,response:S.array(o)},{method:"get",path:`/${t}s/:id`,alias:`get${e}`,description:`Get a ${t}`,response:o},{method:"post",path:`/${t}s`,alias:`create${e}`,description:`Create a ${t}`,parameters:[{name:"body",type:"Body",description:"The object to create",schema:o.partial()}],response:o},{method:"put",path:`/${t}s/:id`,alias:`update${e}`,description:`Update a ${t}`,parameters:[{name:"body",type:"Body",description:"The object to update",schema:o}],response:o},{method:"patch",path:`/${t}s/:id`,alias:`patch${e}`,description:`Patch a ${t}`,parameters:[{name:"body",type:"Body",description:"The object to patch",schema:o.partial()}],response:o},{method:"delete",path:`/${t}s/:id`,alias:`delete${e}`,description:`Delete a ${t}`,response:o}])}var D=class{constructor(o,e,i){this.endpointPlugins=new Map;let n;if(!o)throw Array.isArray(e)?new Error("Zodios: missing base url"):new Error("Zodios: missing api description");let s;if(typeof o=="string"&&Array.isArray(e))s=o,this.api=e,n=i||{};else if(Array.isArray(o)&&!Array.isArray(e))this.api=o,n=e||{};else throw new Error("Zodios: api must be an array");y(this.api),this.options={validate:!0,transform:!0,sendDefaults:!1,...n},this.options.axiosInstance?this.axiosInstance=this.options.axiosInstance:this.axiosInstance=V.create({...this.options.axiosConfig}),s&&(this.axiosInstance.defaults.baseURL=s),this.injectAliasEndpoints(),this.initPlugins(),[!0,"all","request","response"].includes(this.options.validate)&&this.use(R(this.options));}initPlugins(){this.endpointPlugins.set("any-any",new l("any","any")),this.api.forEach(o=>{let e=new l(o.method,o.path);switch(o.requestFormat){case"binary":e.use(P("Content-Type","application/octet-stream"));break;case"form-data":e.use(x());break;case"form-url":e.use(E());break;case"text":e.use(P("Content-Type","text/plain"));break}this.endpointPlugins.set(`${o.method}-${o.path}`,e);});}getAnyEndpointPlugins(){return this.endpointPlugins.get("any-any")}findAliasEndpointPlugins(o){let e=this.api.find(i=>i.alias===o);if(e)return this.endpointPlugins.get(`${e.method}-${e.path}`)}findEnpointPlugins(o,e){return this.endpointPlugins.get(`${o}-${e}`)}get baseURL(){return this.axiosInstance.defaults.baseURL}get axios(){return this.axiosInstance}use(...o){if(typeof o[0]=="object")return this.getAnyEndpointPlugins().use(o[0]);if(typeof o[0]=="string"&&typeof o[1]=="object"){let e=this.findAliasEndpointPlugins(o[0]);if(!e)throw new Error(`Zodios: no alias '${o[0]}' found to register plugin`);return e.use(o[1])}else if(typeof o[0]=="string"&&typeof o[1]=="string"&&typeof o[2]=="object"){let e=this.findEnpointPlugins(o[0],o[1]);if(!e)throw new Error(`Zodios: no endpoint '${o[0]} ${o[1]}' found to register plugin`);return e.use(o[2])}throw new Error("Zodios: invalid plugin registration")}eject(o){var e;if(typeof o=="string"){this.getAnyEndpointPlugins().eject(o);return}(e=this.endpointPlugins.get(o.key))==null||e.eject(o);}injectAliasEndpoints(){this.api.forEach(o=>{o.alias&&(["post","put","patch","delete"].includes(o.method)?this[o.alias]=(e,i)=>this.request({...i,method:o.method,url:o.path,data:e}):this[o.alias]=e=>this.request({...e,method:o.method,url:o.path}));});}async request(o){let e=o,i=this.getAnyEndpointPlugins(),n=this.findEnpointPlugins(e.method,e.url);e=await i.interceptRequest(this.api,e),n&&(e=await n.interceptRequest(this.api,e));let s={...w(e,["params","queries"]),url:q(e),params:e.queries},r=this.axiosInstance.request(s);return n&&(r=n.interceptResponse(this.api,e,r)),r=i.interceptResponse(this.api,e,r),(await r).data}async get(o,...[e]){return this.request({...e,method:"get",url:o})}async post(o,e,...[i]){return this.request({...i,method:"post",url:o,data:e})}async put(o,e,...[i]){return this.request({...i,method:"put",url:o,data:e})}async patch(o,e,...[i]){return this.request({...i,method:"patch",url:o,data:e})}async delete(o,e,...[i]){return this.request({...i,method:"delete",url:o,data:e})}},G=D;function v(t,o){if(t instanceof AxiosError||t&&typeof t=="object"&&"isAxiosError"in t){let e=t;if(e.response){let i=o(e);if(i)return i.some(n=>n.schema.safeParse(e.response.data).success)}}return !1}function W(t,o,e,i){return v(i,n=>O(t,o,e,n))}function X(t,o,e){return v(e,i=>k(t,o,i))}

export { G as Zodios, u as ZodiosError, H as apiBuilder, y as checkApi, x as formDataPlugin, E as formURLPlugin, P as headerPlugin, X as isErrorFromAlias, W as isErrorFromPath, M as makeApi, Q as makeCrudApi, _ as makeEndpoint, L as makeErrors, K as makeParameters, R as zodValidationPlugin };
